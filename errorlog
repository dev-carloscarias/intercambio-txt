node: vs2019

tools:
  jdk:
    flavor: azul
    version: 17
  nuget: 4.1.0
  maven: 3.5.0
  sonarscanner-msbuild: 4.6.2.2108

envs:
  global:
    variables:
      sonarProject: cam-efi-sof2020-web
      project: "Walmart.FelGTSoft2000.Mvc"
      testFilePattern: "./Walmart.FelGTSoft2000.Mvc.Tests/bin/Debug/Walmart.FelGTSoft2000.Mvc.Tests.dll" 

branches:
  - spec: main
    triggers:
      - push:
          call: MainFlow
      - pr:
          disabled: true
  - spec: release
    triggers:
      - push:
          call: ReleaseFlow
      - manual:
          name: Make Release flow
          call: ReleaseFlow
      - pr:
          disabled: true
  - spec: release/*
    triggers:
      - push:
          call: ReleaseFlow
      - manual:
          name: Make Release flow
          call: ReleaseFlow
      - pr:
          disabled: true
  - spec: stage
    triggers:
      - push:
          call: StageFlow
      - manual:
          name: Make Stage flow
          call: StageFlow
      - pr:
          disabled: true
  - spec: develop
    triggers:
      - push:
          call: DevFlow
      - manual:
          name: Make Dev flow
          call: DevFlow
      - pr:
          disabled: true
  - spec: feature/*
    triggers:
      - push:
          call: featureFlow
      - manual:
          name: Make feature flow
          call: featureFlow
      - pr:
          disabled: true

flows:
  default:
    - call: setup
    - call: build
    - node(windows):
      - |
       (name sonar begin) SonarScanner.MSBuild.exe begin /d:sonar.verbose=true /d:sonar.host.url=https://sonar.looper.prod.walmartlabs.com/ /k:${sonarProject} /n:${sonarProject} /v:1.0 /d:sonar.scm.enabled=false /d:sonar.cs.opencover.reportsPaths=coveragereport.xml /d:sonar.cs.nunit.reportsPaths=TestResult.xml
      - (name restore) Nuget.exe restore ${project}.sln
      - (name msbuild) "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe" /t:build ${project}.sln

      # --- Generar cobertura ---
      - (name install opencover) powershell "if (!(Test-Path 'opencover')) { nuget install OpenCover -Version 4.7.1221 -OutputDirectory opencover }"
      - (name install nunit console) powershell "if (!(Test-Path 'nunit')) { nuget install NUnit.ConsoleRunner -Version 3.16.3 -OutputDirectory nunit }"

      - (name run tests with coverage)
        powershell |
          $openCover = 'opencover\OpenCover.4.7.1221\tools\OpenCover.Console.exe'
          $nunit = 'nunit\NUnit.ConsoleRunner.3.16.3\tools\nunit3-console.exe'
          $testDll = '${testFilePattern}'
          & $openCover -register:user -target:$nunit -targetargs:"`$testDll --result=TestResult.xml;format=nunit3" -output:coveragereport.xml -filter:"+[*]* -[*.Tests]*" -oldStyle

      - (name verify files)
        powershell |
          if (Test-Path 'coveragereport.xml') { Write-Host 'OK: coveragereport.xml found' } else { Write-Error 'MISSING: coveragereport.xml' }
          if (Test-Path 'TestResult.xml') { Write-Host 'OK: TestResult.xml found' } else { Write-Error 'MISSING: TestResult.xml' }

      - (name sonar end) SonarScanner.MSBuild.exe ends
  StageFlow:
    - echo "Starting stage process"
    - call: default
  DevFlow:
    - echo "Starting dev process"
    - call: default
  MainFlow:
    - echo "Starting main process"
    - call: default
  featureFlow:
    - echo "Starting feature process"
    - echo "Starting sonar scan"
    - call: default
  ReleaseFlow:
    - echo "Starting release process"
    - echo "Starting sonar scan"
    - call: default
  setup:
    - nuget restore ${project}.sln
  build:
    - MSBuild.exe /t:Rebuild ${project}.sln
  hygieia-publish:
    - hygieia.publishBuild() 
    - hygieia.publishSonar()
    
