node: vs2019
tools:
  jdk:
    flavor: azul
    version: 17
  nuget: 4.1.0
  maven: 3.5.0
  sonarscanner-msbuild: 4.6.2.2108
envs:
  global:
    variables:
      sonarProject: cam-efi-sof2020-web
      project: "Walmart.FelGTSoft2000.Mvc"
      testProject: "Walmart.FelGTSoft2000.Mvc.Tests"
      testFilePattern: "Walmart.FelGTSoft2000.Mvc.Tests\bin\Debug\Walmart.FelGTSoft2000.Mvc.Tests.dll"
branches:
  - spec: main
    triggers:
      - push:
          call: MainFlow
      - pr:
          disabled: true
  - spec: release
    triggers:
      - push:
          call: ReleaseFlow
      - manual:
          name: Make Release flow
          call: ReleaseFlow
      - pr:
          disabled: true
  - spec: release/*
    triggers:
      - push:
          call: ReleaseFlow
      - manual:
          name: Make Release flow
          call: ReleaseFlow
      - pr:
          disabled: true
  - spec: stage
    triggers:
      - push:
          call: StageFlow
      - manual:
          name: Make Stage flow
          call: StageFlow
      - pr:
          disabled: true
  - spec: develop
    triggers:
      - push:
          call: DevFlow
      - manual:
          name: Make Dev flow
          call: DevFlow
      - pr:
          disabled: true
  - spec: feature/*
    triggers:
      - push:
          call: featureFlow
      - manual:
          name: Make feature flow
          call: featureFlow
      - pr:
          disabled: true
flows:
  default:
    - call: setup
    - call: build
    - node(windows):
      - |
       (name sonar begin) SonarScanner.MSBuild.exe begin /d:sonar.verbose=true /d:sonar.host.url=https://sonar.looper.prod.walmartlabs.com/ /k:${sonarProject} /n:${sonarProject} /v:1.0 /d:sonar.scm.enabled=false /d:sonar.cs.opencover.reportsPaths=coverage.xml /d:sonar.coverage.exclusions=**/*Tests*/**
      - (name restore) Nuget.exe restore ${project}.sln
      - (name msbuild) "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe" /t:Rebuild ${project}.sln /p:Configuration=Debug
      - (name install opencover) nuget install OpenCover -Version 4.7.922 -OutputDirectory tools
      - |
        (name run tests with coverage) tools\OpenCover.4.7.922\tools\OpenCover.Console.exe -target:"C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\MSTest.exe" -targetargs:"/testcontainer:${testFilePattern}" -filter:"+[Walmart.FelGTSoft2000.Mvc]* -[Walmart.FelGTSoft2000.Mvc.Tests]*" -register:user -output:coverage.xml -mergebyhash
      - (name sonar end) SonarScanner.MSBuild.exe end
  StageFlow:
    - echo "Starting stage process"
    - call: default
  DevFlow:
    - echo "Starting dev process"
    - call: default
  MainFlow:
    - echo "Starting main process"
    - call: default
  featureFlow:
    - echo "Starting feature process"
    - echo "Starting sonar scan"
    - call: default
  ReleaseFlow:
    - echo "Starting release process"
    - echo "Starting sonar scan"
    - call: default
  setup:
    - nuget restore ${project}.sln
  build:
    - MSBuild.exe /t:Rebuild ${project}.sln /p:Configuration=Debug
  hygieia-publish:
    - hygieia.publishBuild() 
    - hygieia.publishSonar()
