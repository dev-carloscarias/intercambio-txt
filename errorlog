//---------------------------------------------------------------------------------------    
// <copyright file="Soft2000ControllerTest.cs" company="Walmart México y Centroamérica">    
//   Copyright (c) Deny to distribute this code.    
// </copyright>    
// <author>Test Generator</author>    
//----------------------------------------------------------------------------------------
namespace Walmart.FelGTSoft2000.Api.Tests
{
    #region Using   
    using System;
    using System.Collections.Generic;
    using System.Data.SqlClient;
    using System.Diagnostics.CodeAnalysis;
    using System.Linq;
    using System.Threading.Tasks;
    using System.Web.Http;
    using Common.Helpers;
    using log4net;
    using Microsoft.VisualStudio.TestTools.UnitTesting;
    using Repository;
    using V1;
    using Walmart.Common.Helpers;
    #endregion

    /// <summary>
    /// Soft2000 controller test class
    /// </summary>
    [ExcludeFromCodeCoverage]
    [SuppressMessage("StyleCop.CSharp.DocumentationRules", "SA1650:ElementDocumentationMustBeSpelledCorrectly", Justification = "Reviewed.")]
    [SuppressMessage("StyleCop.CSharp.NamingRules", "SA1300:ElementMustBeginWithUpperCaseLetter", Justification = "Reviewed.")]
    [SuppressMessage("StyleCop.CSharp.NamingRules", "SA1306:FieldNamesMustBeginWithLowerCaseLetter", Justification = "Reviewed.")]
    [SuppressMessage("StyleCop.CSharp.NamingRules", "SA1309:FieldNamesMustNotBeginWithUnderscore", Justification = "Reviewed.")]
    [TestClass]
    public class Soft2000ControllerTest : IDisposable
    {
        #region Fields
        /// <summary>
        /// Mock repository
        /// </summary>
        private MockRepository _mockRepository;

        /// <summary>
        /// Token helper 
        /// </summary>
        private ITokenIdentity _token;

        /// <summary>
        /// Soft2000 controller class
        /// </summary>                            
        private Soft2000Controller _target;

        /// <summary>
        /// Soft2000 repository
        /// </summary>
        private ISoft2000Repository _soft2000Repository;

        /// <summary>
        /// Invoice repository
        /// </summary>
        private IInvoiceRepository _invoiceRepository;

        /// <summary>
        /// TaxCeditVoucher repository
        /// </summary>
        private ITaxCeditVoucherRepository _taxCeditVoucherRepository;

        /// <summary>
        /// Trace class
        /// </summary>
        private ILog _log;
        #endregion

        #region Additional test attributes       

        /// <summary>
        ///  Use TestInitialize to run code before running each test
        /// </summary>
        [TestInitialize]
        [System.Diagnostics.CodeAnalysis.SuppressMessage("Microsoft.Reliability", "CA2000:Dispose objects before losing scope", Justification = "This is a Test method. Caller must dispose")]
        public void MyTestInitialize()
        {
            this._mockRepository = new MockRepository();
            this._token = this._mockRepository.StrictMock<ITokenIdentity>();
            // Usar Stub para evitar problemas con NullableContextAttribute en .NET Core/.NET 5+
            this._soft2000Repository = this._mockRepository.Stub<ISoft2000Repository>();
            this._invoiceRepository = this._mockRepository.Stub<IInvoiceRepository>();
            this._taxCeditVoucherRepository = this._mockRepository.Stub<ITaxCeditVoucherRepository>();
            this._log = this._mockRepository.StrictMock<ILog>();
           
            this._target = new Soft2000Controller()
            {
                Soft2000Repository = this._soft2000Repository,
                InvoiceRepository = this._invoiceRepository,
                TaxCeditVoucherRepository = this._taxCeditVoucherRepository,
                TokenIdentityHelper = this._token,
                Log = this._log
            };
        }

        /// <summary>
        /// Use TestCleanup to run code after each test has run
        /// </summary>
        [TestCleanup]
        public void MyTestCleanup()
        {
            this._mockRepository = null;
            this._target = null;
            this._token = null;
            this._soft2000Repository = null;
            this._invoiceRepository = null;
            this._taxCeditVoucherRepository = null;
            this._log = null;
        }
        #endregion

        #region Tests for method Get (GetAll)
        /// <summary>
        /// Get all action success test
        /// </summary>
        [TestMethod]
        public void GetTest()
        {
            IHttpActionResult result = null;

            var soft2000s = new List<Soft2000>()
            {
                new Soft2000
                {
                    IdDocumento = "1"
                }
            };

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._soft2000Repository.GetAll()).Return(Task.FromResult(soft2000s.AsQueryable())).IgnoreArguments();
            this._mockRepository.ReplayAll();
 
            Task.Run(async () =>
            {
                result = await this._target.Get();
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }

        /// <summary>
        /// Get all action exception test
        /// </summary>
        [TestMethod]
        public void Get_SqlExceptionTest()
        {
            IHttpActionResult result = null;

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._soft2000Repository.GetAll()).IgnoreArguments().Throw(CommonTestTools.Generate(40613));
            Expect.Call(delegate { this._log.Error("Error"); }).IgnoreArguments();
            this._mockRepository.ReplayAll();

            Task.Run(async () =>
            {
                result = await this._target.Get();
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }
        #endregion

        #region Tests for method GetDocuments
        /// <summary>
        /// GetDocuments action success test for SV
        /// </summary>
        [TestMethod]
        public void GetDocuments_SVTest()
        {
            IHttpActionResult result = null;

            var documents = new List<TaxCeditVoucher>();

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._taxCeditVoucherRepository.GetAll("estado")).Return(Task.FromResult(documents.AsQueryable())).IgnoreArguments();
            this._mockRepository.ReplayAll();
 
            Task.Run(async () =>
            {
                result = await this._target.Get("SV", "estado");
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }

        /// <summary>
        /// GetDocuments action success test for CR
        /// </summary>
        [TestMethod]
        public void GetDocuments_CRTest()
        {
            IHttpActionResult result = null;

            var documents = new List<Invoice>();

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._invoiceRepository.GetAll("estado")).Return(Task.FromResult(documents.AsQueryable())).IgnoreArguments();
            this._mockRepository.ReplayAll();
 
            Task.Run(async () =>
            {
                result = await this._target.Get("CR", "estado");
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }

        /// <summary>
        /// GetDocuments action exception test
        /// </summary>
        [TestMethod]
        public void GetDocuments_SqlExceptionTest()
        {
            IHttpActionResult result = null;

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._taxCeditVoucherRepository.GetAll("estado")).IgnoreArguments().Throw(CommonTestTools.Generate(40613));
            Expect.Call(delegate { this._log.Error("Error"); }).IgnoreArguments();
            this._mockRepository.ReplayAll();

            Task.Run(async () =>
            {
                result = await this._target.Get("SV", "estado");
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }
        #endregion

        #region Tests for method Post
        /// <summary>
        /// Post action success test
        /// </summary>
        [TestMethod]
        public void Posttest()
        {
            IHttpActionResult result = null;

            var soft2000 = new Soft2000
            {
                LogdId = "1",
                LogdStatus = "status",
                LogdResponse = "response",
                LogdGuatefacturasId = "id",
                Serie = "serie",
                UuId = "uuid",
                Preimpreso = "preimpreso",
                Nit = "nit",
                Nombre = "nombre"
            };

            var soft2000s = new List<Soft2000>() { soft2000 };

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._soft2000Repository.UpDate(null, null, null, null, null, null, null, null, null))
                .Return(Task.FromResult(soft2000s.AsQueryable())).IgnoreArguments();
            this._mockRepository.ReplayAll();

            Task.Run(async () =>
            {
                result = await this._target.Post(soft2000);
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }

        /// <summary>
        /// Post action exception test
        /// </summary>
        [TestMethod]
        public void Post_SqlExceptionTest()
        {
            IHttpActionResult result = null;

            var soft2000 = new Soft2000
            {
                LogdId = "1"
            };

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._soft2000Repository.UpDate(null, null, null, null, null, null, null, null, null))
                .IgnoreArguments().Throw(CommonTestTools.Generate(40613));
            Expect.Call(delegate { this._log.Error("Error"); }).IgnoreArguments();
            this._mockRepository.ReplayAll();

            Task.Run(async () =>
            {
                result = await this._target.Post(soft2000);
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }
        #endregion

        #region Tests for method Post (UpDate)
        /// <summary>
        /// Post Update action success test
        /// </summary>
        [TestMethod]
        public void PostUpdateTest()
        {
            IHttpActionResult result = null;

            var soft2000 = new Soft2000
            {
                LogdId = "1",
                LogdStatus = "status",
                LogdResponse = "response",
                LogdGuatefacturasId = "id",
                Serie = "serie",
                UuId = "uuid",
                Preimpreso = "preimpreso",
                Nit = "nit",
                Nombre = "nombre"
            };

            var soft2000s = new List<Soft2000>() { soft2000 };

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._soft2000Repository.UpDate(null, null, null, null, null, null, null, null, null))
                .Return(Task.FromResult(soft2000s.AsQueryable())).IgnoreArguments();
            this._mockRepository.ReplayAll();

            Task.Run(async () =>
            {
                result = await this._target.Post(soft2000, "GT");
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }

        /// <summary>
        /// Post Update action exception test
        /// </summary>
        [TestMethod]
        public void PostUpdate_SqlExceptionTest()
        {
            IHttpActionResult result = null;

            var soft2000 = new Soft2000
            {
                LogdId = "1"
            };

            SetupResult.For(this._token.GetOwnerIdFromToken(null)).Return("tokenvalidoparaeltest");
            Expect.Call(this._soft2000Repository.UpDate(null, null, null, null, null, null, null, null, null))
                .IgnoreArguments().Throw(CommonTestTools.Generate(40613));
            Expect.Call(delegate { this._log.Error("Error"); }).IgnoreArguments();
            this._mockRepository.ReplayAll();

            Task.Run(async () =>
            {
                result = await this._target.Post(soft2000, "GT");
            }).GetAwaiter().GetResult();

            Assert.IsNotNull(result);
            this._mockRepository.VerifyAll();
        }
        #endregion

        #region Dispose
        /// <summary>
        /// Free native resources
        /// </summary>
        public void Dispose()
        {
            this.Dispose(true);
            GC.SuppressFinalize(this);
        }

        /// <summary>
        /// Dispose managed resources
        /// </summary>
        /// <param name="disposing">Dispose flag</param>
        protected virtual void Dispose(bool disposing)
        {
            if (disposing)
            {
                this._target?.Dispose();
            }
        }
        #endregion
    }
}


